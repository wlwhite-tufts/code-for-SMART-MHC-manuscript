<ROSETTASCRIPTS>
	<SCOREFXNS>
        <ScoreFunction name="sfxn_cart" weights="beta_nov16_cart" />
        <ScoreFunction name="sfxn_fa_atr" weights="empty" >
            <Reweight scoretype="fa_atr" weight="1" />
        </ScoreFunction>
	</SCOREFXNS>
    <RESIDUE_SELECTORS>

        <Chain name="chainA" chains="A"/>
        <Chain name="chainB" chains="B"/>

        <Slice name="pocket" slice_mode="CONTIGUOUS_OR" selector="chainB" indices="1,2,3,4" />
        <And name="target_not_pocket" selectors="chainB">
            <Not selector="pocket" />
        </And>

    </RESIDUE_SELECTORS>
    <MOVERS>
        <DeleteRegionMover name="delete_target_not_pocket" residue_selector="target_not_pocket" rechain="false" />
        <SwitchChainOrder name="binder_chain_A" chain_order="21" />

    </MOVERS>
    <FILTERS>

        <Sasa name="interface_buried_sasa_filter_before" threshold="%%initial_sasa_threshold%%" confidence="1" />

        <CompoundStatement name="motif_graft_filter" >
            <AND filter_name="interface_buried_sasa_filter_before" />
        </CompoundStatement>

    </FILTERS>
	<MOVERS>
		//Here is the mover that generates multiple pose results
        // size_delta = 0:0
        // replacement_delta = -0:0
		<MotifGraft name="motif_grafting"
			context_structure="%%targetpdb%%"
			motif_structure="%%motifpdb%%"
			RMSD_tolerance="0.5" 
			NC_points_RMSD_tolerance="1.0"
            hotspots="%%hotspots%%"
			clash_score_cutoff="10" 
			clash_test_residue="ALA"
			full_motif_bb_alignment="1"  
			allow_independent_alignment_per_fragment="0"
			graft_only_hotspots_by_replacement="1" 
			only_allow_if_N_point_match_aa_identity="0"
			only_allow_if_C_point_match_aa_identity="0" 
			revert_graft_to_native_sequence="1" 
			allow_repeat_same_graft_output="0" 
            reinit_every_apply="1"
            output_cluster_tolerance="2.0" 
            output_filter="motif_graft_filter"/>
		//HERE You add  all the other design movers
		<MultiplePoseMover name="MPM_predictor_soft_pack_v6" max_input_poses="50">
		<SELECT>
		</SELECT>
			<ROSETTASCRIPTS>
                <SCOREFXNS>
                    <ScoreFunction name="sfxn_cart" weights="beta_nov16_cart" />
                    <ScoreFunction name="sfxn_soft" weights="beta_nov16_soft" />
                    <ScoreFunction name="sfxn" weights="beta_nov16" />
                    <ScoreFunction name="sfxn_fa_atr" weights="empty" >
                        <Reweight scoretype="fa_atr" weight="1" />
                    </ScoreFunction>
                    <ScoreFunction name="vdw_sol" weights="empty" >
                        <Reweight scoretype="fa_atr" weight="1.0" />
                        <Reweight scoretype="fa_rep" weight="0.55" />
                        <Reweight scoretype="fa_sol" weight="1.0" />
                    </ScoreFunction>
                    <ScoreFunction name="sfxn_fast" weights="beta_nov16_soft" >
                        # lk_ball is slooooooooooow
                        <Reweight scoretype="lk_ball" weight="0" />
                        <Reweight scoretype="lk_ball_iso" weight="0" />
                        <Reweight scoretype="lk_ball_bridge" weight="0" />
                        <Reweight scoretype="lk_ball_bridge_uncpl" weight="0" />

                        # turn off the next slowest parts of the score function
                        <Set etable_no_hydrogens="true" />
                        <Reweight scoretype="fa_elec" weight="0" />
                        <Reweight scoretype="fa_intra_atr_xover4" weight="0" />
                        <Reweight scoretype="fa_intra_rep_xover4" weight="0" />
                        <Reweight scoretype="fa_intra_sol_xover4" weight="0" />
                        <Reweight scoretype="fa_intra_elec" weight="0" />
                        <Reweight scoretype="hbond_sr_bb" weight="0" />
                        <Reweight scoretype="hbond_lr_bb" weight="0" />
                        <Reweight scoretype="hbond_bb_sc" weight="0" />
                        <Reweight scoretype="hbond_sc" weight="0" />

                    </ScoreFunction>                    
                    ScoreFunction name="sfxn_aa" weights="ref2015" >
                        Reweight scoretype="aa_composition" weight="1.0" />
                    /ScoreFunction>
                </SCOREFXNS>
                <RESIDUE_SELECTORS>
                    <ResiduePDBInfoHasLabel name="HOTSPOT_Res" property="HOTSPOT" />
                    <Chain name="chainA" chains="A"/>
                    <Chain name="chainB" chains="B"/>
                    <Neighborhood name="interface_chA" selector="chainB" distance="8.0" />
                    <Neighborhood name="interface_chB" selector="chainA" distance="8.0" />
                    <And name="AB_interface" selectors="interface_chA,interface_chB" />
                    <Not name="Not_interface" selector="AB_interface" />
                    <And name="actual_interface_chB" selectors="AB_interface,chainB" />
                    <And name="not_interface_chB" selectors="Not_interface,chainB" />
                    <StoredResidueSubset name="stored_AB_interface" subset_name="stored_AB_interface" />

		    <Slice name="patchdock_res" indices="%%patchdock_res%%" selector="chainB" />

                    <ResidueName name="apolar" residue_name3="ALA,CYS,PHE,ILE,LEU,MET,THR,PRO,VAL,TRP,TYR" />
                    <Not name="polar" selector="apolar" />

                    <ResidueName name="pro_gly_cys_positions" residue_name3="PRO,GLY,CYS,CYD" />
                </RESIDUE_SELECTORS>
                <RESIDUE_SELECTORS>

                    <Slice name="pocket" slice_mode="CONTIGUOUS_OR" selector="chainB" indices="1,2,3,4" />
                    <And name="target_not_pocket" selectors="chainB">
                        <Not selector="pocket" />
                    </And>

                </RESIDUE_SELECTORS>

                <RESIDUE_SELECTORS>
                    <!-- Layer Design -->
                    <Layer name="surface" select_core="false" select_boundary="false" select_surface="true" use_sidechain_neighbors="true"/>
                    <Layer name="boundary" select_core="false" select_boundary="true" select_surface="false" use_sidechain_neighbors="true"/>
                    <Layer name="core" select_core="true" select_boundary="false" select_surface="false" use_sidechain_neighbors="true"/>
                    <SecondaryStructure name="sheet" overlap="0" minH="3" minE="2" include_terminal_loops="false" use_dssp="true" ss="E"/>
                    <SecondaryStructure name="entire_loop" overlap="0" minH="3" minE="2" include_terminal_loops="true" use_dssp="true" ss="L"/>
                    <SecondaryStructure name="entire_helix" overlap="0" minH="3" minE="2" include_terminal_loops="false" use_dssp="true" ss="H"/>
                    <And name="helix_cap" selectors="entire_loop">
                        <PrimarySequenceNeighborhood lower="1" upper="0" selector="entire_helix"/>
                    </And>
                    <And name="helix_start" selectors="entire_helix">
                        <PrimarySequenceNeighborhood lower="0" upper="1" selector="helix_cap"/>
                    </And>
                    <And name="helix" selectors="entire_helix">
                        <Not selector="helix_start"/>
                    </And>
                    <And name="loop" selectors="entire_loop">
                        <Not selector="helix_cap"/>
                    </And>

                </RESIDUE_SELECTORS>

                <TASKOPERATIONS>        
                    <DesignRestrictions name="layer_design_no_core_polars">
                        <Action selector_logic="surface AND helix_start"  aas="DEHKPQR"/>
                        <Action selector_logic="surface AND helix"        aas="EHKQR"/>
                        <Action selector_logic="surface AND sheet"        aas="EHKNQRST"/>
                        <Action selector_logic="surface AND loop"         aas="DEGHKNPQRST"/>
                        <Action selector_logic="boundary AND helix_start" aas="ADEHIKLNPQRSTVWY"/>
                        <Action selector_logic="boundary AND helix"       aas="ADEHIKLNQRSTVWY"/>
                        <Action selector_logic="boundary AND sheet"       aas="DEFHIKLNQRSTVWY"/>
                        <Action selector_logic="boundary AND loop"        aas="ADEFGHIKLNPQRSTVWY"/>
                        <Action selector_logic="core AND helix_start"     aas="AFILMPVWY"/>
                        <Action selector_logic="core AND helix"           aas="AFILVWY"/>
                        <Action selector_logic="core AND sheet"           aas="FILVWY"/>
                        <Action selector_logic="core AND loop"            aas="AFGILPVWY"/>
                        <Action selector_logic="helix_cap"                aas="DNST"/>
                    </DesignRestrictions>
                </TASKOPERATIONS>
                <TASKOPERATIONS>
                    <ProteinProteinInterfaceUpweighter name="upweight_interface" interface_weight="3" />
                    <ProteinInterfaceDesign name="pack_long" design_chain1="0" design_chain2="0" jump="1" interface_distance_cutoff="15"/>
                    <InitializeFromCommandline name="init" />
                    <IncludeCurrent name="current" />
                    <LimitAromaChi2 name="limitchi2" chi2max="110" chi2min="70" include_trp="True" />
                    <ExtraRotamersGeneric name="ex1_ex2" ex1="1" ex2aro="1" />

                    <OperateOnResidueSubset name="restrict_target_not_interface" selector="not_interface_chB">
                        <PreventRepackingRLT/>
                    </OperateOnResidueSubset>

                    <OperateOnResidueSubset name="restrict_target" selector="chainB">
                        <PreventRepackingRLT/>
                    </OperateOnResidueSubset>
                    <OperateOnResidueSubset name="prevent_hotspots_from_repacking" selector="HOTSPOT_Res">
                        <PreventRepackingRLT/>
                    </OperateOnResidueSubset>
                    <OperateOnResidueSubset name="restrict_to_interface" selector="Not_interface">
                        <PreventRepackingRLT/>
                    </OperateOnResidueSubset>
                    <OperateOnResidueSubset name="restrict_target2repacking" selector="chainB">
                        <RestrictToRepackingRLT/>
                    </OperateOnResidueSubset>
                    <DisallowIfNonnative name="disallow_GLY" resnum="0" disallow_aas="G" />
                    <DisallowIfNonnative name="disallow_PRO" resnum="0" disallow_aas="P" />
                    <SelectBySASA name="PR_monomer_core" mode="sc" state="monomer" probe_radius="2.2" core_asa="10" surface_asa="10" core="0" boundary="1" surface="1" verbose="0" />

                    <OperateOnResidueSubset name="restrict_PRO_GLY_CYS" selector="pro_gly_cys_positions">
                        <PreventRepackingRLT/>
                    </OperateOnResidueSubset>

                    <RestrictAbsentCanonicalAAS name="AVILF"  keep_aas="AVILF" />
                </TASKOPERATIONS>
                <MOVERS>


                    <SavePoseMover name="save_output" restore_pose="0" reference_name="pose_output" />
                    <SavePoseMover name="load_output" restore_pose="1" reference_name="pose_output" />
                    <SavePoseMover name="save_minned" restore_pose="0" reference_name="pose_minned" />
                    <SavePoseMover name="load_minned" restore_pose="1" reference_name="pose_minned" />


                    <SwitchChainOrder name="chain1onlypre" chain_order="1" />
                    <ScoreMover name="scorepose" scorefxn="sfxn" verbose="false" />
                    <ParsedProtocol name="chain1only">
                        <Add mover="chain1onlypre" />
                        <Add mover="scorepose" />
                    </ParsedProtocol>
                    <TaskAwareMinMover name="min" scorefxn="sfxn" bb="0" chi="1" task_operations="pack_long" />
                    <TaskAwareMinMover name="min_soft" scorefxn="sfxn_soft" bb="0" chi="1" task_operations="pack_long" />

                    <DeleteRegionMover name="delete_polar" residue_selector="polar" rechain="false" />
                    <DeleteRegionMover name="delete_target_not_pocket" residue_selector="target_not_pocket" rechain="false" />
                    <SwitchChainOrder name="binder_chain_A" chain_order="21" />

                    <ParsedProtocol name="swap_then_delete_target_not_pocket" >
                        <Add mover="binder_chain_A" />
                        <Add mover="delete_target_not_pocket" />
                    </ParsedProtocol>

                    <ParsedProtocol name="load_then_delete_target_not_pocket" >
                        <Add mover="load_minned" />
                        <Add mover="delete_target_not_pocket" />
                    </ParsedProtocol>

                </MOVERS>
                <FILTERS>
                    <ScoreType name="score_cart" scorefxn="sfxn_cart" score_type="cart_bonded" threshold="200" confidence="1" />
                    
                    <Sasa name="interface_buried_sasa_cut" threshold="%%initial_sasa_threshold%%" confidence="1" />

                    <Sasa name="interface_buried_sasa_filter_before" threshold="%%initial_sasa_threshold%%" confidence="1" />

		    # confidence is the probability that the pose will be thrown out if the threshold is not exceeded
                    <ContactMolecularSurface name="contact_patch" distance_weight="0.5" target_selector="patchdock_res" binder_selector="chainA" min_interface="%%contact_patch_threshold%%" confidence="1" />

                    ################################### I think we should turn the repack_bound to false, but maybe not! ########################################################
                    <Ddg name="ddg"  threshold="-10" jump="1" repeats="5" repack="1" relax_mover="min" confidence="0" scorefxn="sfxn" />


                    <Ddg name="ddg_soft"  threshold="-10" jump="1" repeats="5" repack="1" relax_mover="min_soft" confidence="0" scorefxn="sfxn_soft" />
                    <Ddg name="ddg_norepack"  jump="1" repeats="1" repack="0" relax_mover="min" confidence="0" scorefxn="sfxn" />

                    
                    <ShapeComplementarity name="interface_sc" verbose="0" min_sc="0.55" write_int_area="1" write_median_dist="1" jump="1" confidence="0"/>

                    
                    ### score function monomer terms
                    <ScoreType name="total_score_MBF" scorefxn="sfxn" score_type="total_score" threshold="0" confidence="0" />
                    <MoveBeforeFilter name="total_score_monomer" mover="chain1only" filter="total_score_MBF" confidence="0" />
                    <ResidueCount name="res_count_MBF" max_residue_count="9999" confidence="0"/>
                    <MoveBeforeFilter name="res_count_monomer" mover="chain1only" filter="res_count_MBF" confidence="0" />

                       
                    <CalculatorFilter name="score_per_res" equation="total_score_monomer / res" threshold="-3.5" confidence="0">
                        <Var name="total_score_monomer" filter="total_score_monomer"/>
                        <Var name="res" filter="res_count_monomer"/>
                    </CalculatorFilter>

                    
                    <InterfaceHydrophobicResidueContacts name="hydrophobic_residue_contacts_pre" target_selector="chainB" binder_selector="chainA" scorefxn="sfxn_soft" confidence="0"/> 


                    <Ddg name="ddg_hydrophobic_pre"  threshold="-10" jump="1" repeats="1" repack="0" confidence="0" scorefxn="vdw_sol" />
                    <MoveBeforeFilter name="ddg_hydrophobic" mover="delete_polar" filter="ddg_hydrophobic_pre" confidence="0"/>


                    <Ddg name="fa_atr_pocket_minned_pre"  threshold="-15" jump="1" repeats="1" repack="0" confidence="0" scorefxn="sfxn_fa_atr" />
                    <MoveBeforeFilter name="fa_atr_pocket_minned" mover="load_then_delete_target_not_pocket" filter="fa_atr_pocket_minned_pre" confidence="0"/>

                    <ContactMolecularSurface name="contact_molecular_surface" distance_weight="0.5" target_selector="chainA" binder_selector="chainB" confidence="0" />


                    <ScorePoseSegmentFromResidueSelectorFilter name="has_sheet" in_context="1" residue_selector="sheet" scorefxn="sfxn" confidence="0" />

                </FILTERS>


                <MOVERS>


                    <PackRotamersMover name="fast_pack_except_hotspots" scorefxn="sfxn" task_operations="current,restrict_to_interface,restrict_target,PR_monomer_core,restrict_PRO_GLY_CYS,prevent_hotspots_from_repacking,upweight_interface,AVILF"/>

                    <TaskAwareMinMover name="hard_min_cart" scorefxn="sfxn_cart" chi="1" bb="1" tolerance="0.01" cartesian="true" task_operations="restrict_target_not_interface,restrict_target2repacking">
                        MoveMap name="MM" >
                                Chain number="1" chi="true" bb="true" />
                                Chain number="2" chi="true" bb="false" />
                                Jump number="1" setting="true" />
                        /MoveMap>
                    </TaskAwareMinMover>



                </MOVERS>
                <FILTERS>

		    <MoveBeforeFilter name="contact_patch_minned" mover="load_minned" filter="contact_patch" confidence="1" />
                    <MoveBeforeFilter name="interface_buried_sasa_minned_cut" mover="load_minned" filter="interface_buried_sasa_cut" confidence="1" />
                    <MoveBeforeFilter name="ddg_norepack_minned" mover="load_minned" filter="ddg_norepack" confidence="0" />
                    <MoveBeforeFilter name="ddg_hydrophobic_minned" mover="load_minned" filter="ddg_hydrophobic" confidence="0" />
                    <MoveBeforeFilter name="interface_sc_minned" mover="load_minned" filter="interface_sc" confidence="0" />
                    <MoveBeforeFilter name="score_per_res_minned" mover="load_minned" filter="score_per_res" confidence="0" />
                    MoveBeforeFilter name="contact_molecular_surface_minned" mover="load_minned" filter="score_per_res" confidence="0" />
                    <MoveBeforeFilter name="hydrophobic_residue_contacts_minned" mover="load_minned" filter="hydrophobic_residue_contacts_pre" confidence="0" />
                </FILTERS>
                <APPLY_TO_POSE>
                </APPLY_TO_POSE>
                <PROTOCOLS>
                    <Add mover="binder_chain_A" /> # sorry Daniel
                    Add filter="score_cart" />

                    Add filter_name="interface_buried_sasa_filter_before" />
                    Add filter="interface_buried_sasa_filter_before" />
                    <Add mover="save_output" />

                    <Add mover="fast_pack_except_hotspots" />
                    <Add mover="save_minned" />

                    <Add filter_name="interface_buried_sasa_minned_cut" />
                    <Add filter_name="fa_atr_pocket_minned" />
                    <Add filter_name="hydrophobic_residue_contacts_minned" />
		    <Add filter_name="contact_patch_minned" />

                    <Add mover="load_output" />

                    <Add filter_name="has_sheet" />


                </PROTOCOLS>
                <OUTPUT />
            </ROSETTASCRIPTS>
		</MultiplePoseMover>

	</MOVERS>

	<APPLY_TO_POSE>
	</APPLY_TO_POSE>

	<PROTOCOLS >
	//HERE you combine everything together
	<Add mover_name="motif_grafting" />
	<Add mover_name="MPM_predictor_soft_pack_v6" />
	</PROTOCOLS>


</ROSETTASCRIPTS>
